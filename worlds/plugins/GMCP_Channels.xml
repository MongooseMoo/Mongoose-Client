<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Sunday, December 18, 2022, 1:20 PM -->
<!-- MuClient version 5.07-pre -->

<!-- Plugin "GMCP_Channels" generated by Plugin Wizard -->

<muclient>
<plugin
   name="GMCP_Channels"
   author="Christopher Toth"
   id="fcb5b9f023690a92414ec48a"
   language="Lua"
   purpose="Add GMCP Channel messages to the Channel History Plugin"
   date_written="2022-12-18 13:17:04"
   requires="5.07"
   version="1.0"
   >
<description trim="y">
<![CDATA[
This plugin is a bridge between GMCP channel messages and the Channel History plugin.
]]>
</description>

</plugin>


<!--  Script  -->


<script>
<![CDATA[
json=require("json")


function strSplit(str, delim, maxNb)
   -- Eliminate bad cases...
   if string.find(str, delim) == nil then
      return { str }
   end
   if maxNb == nil or maxNb < 1 then
      maxNb = 0    -- No limit
   end
   local result = {}
   local pat = "(.-)" .. delim .. "()"
   local nb = 0
   local lastPos
   for part, pos in string.gfind(str, pat) do
      nb = nb + 1
      result[nb] = part
      lastPos = pos
      if nb == maxNb then
         break
      end
   end
   -- Handle the last field
   if nb ~= maxNb then
      result[nb + 1] = string.sub(str, lastPos)
   end
   return result
end

function OnPluginBroadcast (msg, id, name, text)
if id=="74f8c420df7d59ad5aa66246" then
text=Replace(text,"\\u00","~")
package,params=unpack(strSplit(StripANSI(text)," ___ "))
f=_G["gmcp_handle_"..Replace(package:lower(),".","_")]
if f~=nil then
f(json.decode(params))
else
end
end
end

function gmcp_handle_comm_channel_text(data)
data.channel=data.channel or ""
data.talker=data.talker or "unknown sender"
if data.channel=="say" then
handleSay(data)
end
if data.channel ~= "say" then
Execute("history_add " .. data.channel .. "=(" ..data.talker ..") " .. data.text)
end
end

]]>
</script>


<!--  Plugin help  -->

<aliases>
  <alias
   script="OnHelp"
   match="GMCP_Channels:help"
   enabled="y"
  >
  </alias>
</aliases>

<script>
<![CDATA[
function OnHelp ()
  world.Note (world.GetPluginInfo (world.GetPluginID (), 3))
end
]]>
</script> 

</muclient>
